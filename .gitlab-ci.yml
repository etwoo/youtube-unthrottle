image: archlinux/archlinux:base-devel

.build_dependencies: &build_dependencies
    - pacman --noconfirm -Sy cmake clang curl duktape git libseccomp pcre2

.build_steps: &build_steps
    - cmake -Wdev -Werror=dev -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTING=1 . -B ./build
    - cmake --build ./build
    - cd ./build/tests && ctest --output-junit junit.xml -E '^cli-try-sandbox|sandbox-landlock$' .

build_with_gcc:
  stage: build
  before_script:
    - *build_dependencies
  script:
    - export CC=gcc
    - export CXX=g++
    - *build_steps
  artifacts:
    when: always
    paths:
      - ./build/tests/junit.xml
    reports:
      junit: ./build/tests/junit.xml

build_with_clang:
  stage: build
  before_script:
    - *build_dependencies
  script:
    - export CC=clang
    - export CXX=clang++
    - *build_steps
  artifacts:
    when: always
    paths:
      - ./build/tests/junit.xml
    reports:
      junit: ./build/tests/junit.xml

format:
  stage: build
  before_script:
    - *build_dependencies
  script:
    - cmake -Wdev -Werror=dev -DCMAKE_BUILD_TYPE=Debug . -B ./build
    - cmake --build ./build --target fmt
